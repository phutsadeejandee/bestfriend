<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Test;
use App\Models\User;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Session;


class TestController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $userId = Auth::id(); // ดึง user_id ของผู้ใช้ที่ login อยู่
        $tests = Test::where('user_id', $userId)->get();
        
        $e_i_questions = [
            ['question' => '1. เมื่อคุณมีเวลาว่างในวันหยุด คุณมักจะ', 
             'option_a' => 'นัดเพื่อนออกไปเที่ยวหรือทำกิจกรรมร่วมกัน', 
             'option_b' => 'ใช้เวลาอยู่บ้านคนเดียวหรือกับคนสนิทไม่กี่คน'],
             
            ['question' => '2. คุณรู้สึกเติมพลังเมื่อ', 
             'option_a' => 'อยู่ในสถานการณ์ที่มีผู้คนมากมาย เช่น งานสังสรรค์', 
             'option_b' => 'ได้มีเวลาสงบ ๆ คนเดียว'],
             
            ['question' => '3. คุณมักจะคิดก่อนพูด หรือพูดก่อนคิด?', 
             'option_a' => 'พูดก่อนคิด แล้วค่อยมาเรียบเรียงทีหลัง', 
             'option_b' => 'คิดให้ดีก่อนพูดออกมา'],
             
            ['question' => '4. ในห้องเรียนหรือการประชุม คุณ', 
             'option_a' => 'ชอบแสดงความคิดเห็น ออกความเห็นทันที', 
             'option_b' => 'ฟังมากกว่าพูด และจะพูดเมื่อคิดว่าจำเป็นจริง ๆ'],
             
            ['question' => '5. เมื่อพบคนแปลกหน้าในงานสังคม', 
             'option_a' => 'คุณสามารถเริ่มบทสนทนาได้อย่างง่ายดาย', 
             'option_b' => 'คุณรู้สึกเขินหรือรอให้คนอื่นเริ่มก่อน'],
             
            ['question' => '6. เมื่อคุณต้องเริ่มทำงานกลุ่มกับคนที่ไม่รู้จัก', 
             'option_a' => 'คุณรู้สึกตื่นเต้นที่ได้รู้จักคนใหม่ ๆ', 
             'option_b' => 'คุณรู้สึกเครียดเล็กน้อยและต้องใช้เวลาปรับตัว'],
             
            ['question' => '7. การพูดต่อหน้าคนเยอะ ๆ', 
             'option_a' => 'ไม่ใช่ปัญหาเลย คุณรู้สึกสนุกและมั่นใจ', 
             'option_b' => 'คุณรู้สึกกดดันและต้องเตรียมตัวอย่างมาก'],
             
            ['question' => '8. เวลาที่คุณมีเรื่องไม่สบายใจ', 
             'option_a' => 'คุณมักจะระบายกับเพื่อนหรือคนรอบข้าง', 
             'option_b' => 'คุณชอบเก็บไว้คิดคนเดียวก่อน'],
             
            ['question' => '9. ในปาร์ตี้หรือกิจกรรมรวมกลุ่ม', 
             'option_a' => 'คุณมักจะอยู่ตรงกลางของเหตุการณ์ พูดคุยกับหลายคน', 
             'option_b' => 'คุณมักหามุมเงียบ ๆ หรือคุยกับไม่กี่คนเท่านั้น'],
             
            ['question' => '10. คุณรู้สึกว่าเวลาที่คุณใช้ในการอยู่คนเดียว', 
             'option_a' => 'เป็นช่วงเวลาที่ทำให้คุณรู้สึกเหงาหรือเบื่อ', 
             'option_b' => 'เป็นช่วงเวลาที่ทำให้คุณรู้สึกสงบและเติมพลัง'],
        ];

        $s_n_questions = [
            ['question' => '11. เวลาคุณเรียนรู้สิ่งใหม่:', 
             'option_a' => 'A.คุณอยากได้คำอธิบายแบบชัดเจน มีตัวอย่างจริง', 
             'option_b' => 'B.คุณชอบเข้าใจแนวคิดกว้าง ๆ แล้วค่อยลงลึก'],
             
            ['question' => '12. เมื่อเจอสถานการณ์แปลกใหม่:', 
             'option_a' => 'A.คุณพยายามเช็คความเป็นจริงก่อนว่ามันคืออะไร', 
             'option_b' => 'B.คุณจินตนาการถึงสิ่งที่มันอาจจะเป็นหรือจะพัฒนาไปยังไง'],
             
            ['question' => '13. คุณให้ความสำคัญกับ:', 
             'option_a' => 'A.สิ่งที่จับต้องได้ เห็นชัดว่าเกิดขึ้นจริง', 
             'option_b' => 'B.แรงบันดาลใจ ความเป็นไปได้ และอนาคตที่อาจเกิดขึ้น'],
             
            ['question' => '14. เวลาต้องทำงานตามขั้นตอน:', 
             'option_a' => 'A.คุณชอบทำตามลำดับเดิมทีละขั้น', 
             'option_b' => 'B.คุณมักหาวิธีใหม่ ๆ หรือข้ามไปข้างหน้าเลย'],
             
            ['question' => '15. เวลาฟังเรื่องราวของใครบางคน:', 
             'option_a' => 'A.คุณโฟกัสไปที่รายละเอียดและข้อเท็จจริงในเรื่องนั้น', 
             'option_b' => 'B.คุณสนใจเบื้องหลัง ความหมาย หรือสิ่งที่ซ่อนอยู่ในเรื่องนั้น'],
             
            ['question' => '16. ถ้ามีคนบอกว่า “จะมีการเปลี่ยนแปลงครั้งใหญ่”:', 
             'option_a' => 'A.คุณจะถามว่า “อะไรจะเปลี่ยน? เมื่อไหร่? มีแผนยังไง?”', 
             'option_b' => 'B.คุณเริ่มคิดต่อเลยว่า “แล้วถ้าเปลี่ยนแบบนี้จะเกิดอะไรขึ้นต่อไป?”'],
             
            ['question' => '17. เวลาคุณทำงานหรือเรียน:', 
             'option_a' => 'A.คุณชอบให้มีแผนงาน รายละเอียด และขั้นตอนที่ชัดเจน', 
             'option_b' => 'B.คุณชอบมองเป้าหมายโดยรวม แล้วค่อย ๆ สร้างวิธีการไปตามทาง'],
             
            ['question' => '18. เวลาเล่าเรื่องบางอย่างให้คนอื่นฟัง:', 
             'option_a' => 'A.คุณมักเล่าทุกเหตุการณ์ตามลำดับเวลาอย่างชัดเจน', 
             'option_b' => 'B.คุณเน้นเล่าความหมายของเรื่องนั้น หรือความรู้สึก/ข้อคิดที่ได้'],
             
            ['question' => '19. เวลามีโปรเจกต์ใหม่ ๆ:', 
             'option_a' => 'A.คุณต้องการข้อมูลครบถ้วนก่อนถึงจะเริ่มลงมือ', 
             'option_b' => 'B.คุณพร้อมลอง เริ่มเลย แล้วค่อยปรับตามระหว่างทาง'],
             
            ['question' => '20. เวลาคุณนึกถึง “อนาคต”:', 
             'option_a' => 'A.คุณจะคิดถึงสิ่งที่คุณวางแผนไว้ชัดเจน เช่น การทำงาน ครอบครัว รายได้', 
             'option_b' => 'B.คุณจะนึกถึงภาพใหญ่ เช่น ชีวิตในอุดมคติ การเปลี่ยนแปลง หรือไอเดียใหม่ ๆ']
        ];

        $t_f_questions = [
            ['question' => '21. เวลาต้องตัดสินใจสำคัญ:', 
             'option_a' => 'คุณวิเคราะห์ข้อดีข้อเสียอย่างเป็นเหตุเป็นผล', 
             'option_b' => 'คุณคิดถึงความรู้สึกของทุกคนที่เกี่ยวข้อง'],
             
            ['question' => '22. ในการโต้เถียง:', 
             'option_a' => 'คุณพยายามชี้ให้เห็นว่าความคิดเห็นไหนมีเหตุผลมากกว่า', 
             'option_b' => 'คุณพยายามรักษาน้ำใจและหลีกเลี่ยงความขัดแย้ง'],
             
            ['question' => '23. คนรอบตัวมองว่าคุณ:', 
             'option_a' => 'เป็นคนตรงไปตรงมาและพูดตามความจริง', 
             'option_b' => 'เป็นคนอ่อนโยนและให้ความสำคัญกับความรู้สึกคนอื่น'],
             
            ['question' => '24. ถ้าคุณต้องบอกเพื่อนว่าเค้าทำอะไรผิด:', 
             'option_a' => 'คุณจะพูดตรง ๆ เพราะคิดว่านั่นคือสิ่งที่ถูกต้อง', 
             'option_b' => 'คุณจะเลือกคำพูดให้เบาที่สุด เพื่อไม่ให้เพื่อนเสียใจ'],
             
            ['question' => '25. เวลาเห็นคนอื่นมีปัญหา:', 
             'option_a' => 'A.คุณอยากช่วยหาทางแก้ให้เร็วที่สุด', 
             'option_b' => 'B.คุณอยากฟังและอยู่เคียงข้างให้เขารู้สึกดีขึ้น'],
             
            ['question' => '26. สำหรับคุณ ความยุติธรรมคือ:', 
             'option_a' => 'การใช้มาตรฐานเดียวกันกับทุกคน', 
             'option_b' => 'การดูบริบทและเข้าใจความรู้สึกของแต่ละคน'],
             
            ['question' => '27. เมื่อคุณได้รับคำวิจารณ์:', 
             'option_a' => 'คุณรับฟังเพื่อหาว่าควรปรับปรุงอะไรตรงไหน', 
             'option_b' => 'คุณอาจรู้สึกเสียใจ แม้จะรู้ว่าคำวิจารณ์นั้นมีเหตุผล'],
             
            ['question' => '28. เวลาคุณต้องเลือกฝ่ายในเรื่องขัดแย้ง:', 
             'option_a' => 'คุณยืนข้างความคิดที่ "ถูกต้อง" โดยไม่เกี่ยงว่าใครเป็นใคร', 
             'option_b' => 'คุณพยายามเข้าใจทุกฝ่าย และเลือกสิ่งที่รักษาความสัมพันธ์ได้มากที่สุด'],
             
            ['question' => '29. ถ้ามีเพื่อนร่วมงานทำพลาด:', 
             'option_a' => 'คุณจะบอกตรง ๆ เพื่อให้เขารู้และแก้ไข', 
             'option_b' => 'คุณจะพูดอย่างระมัดระวัง เพราะไม่อยากให้เขารู้สึกแย่'],
             
            ['question' => '30. คุณรู้สึกพอใจกับการตัดสินใจเมื่อ:', 
             'option_a' => 'มันเป็นการตัดสินใจที่ "ถูกต้อง" ตามตรรกะ', 
             'option_b' => 'มันเป็นการตัดสินใจที่ "ดีต่อใจ" สำหรับคุณและผู้อื่น'],
        ];

        $j_p_questions = [
            ['question' => '31. เวลาคุณวางแผนไปเที่ยว:', 
             'option_a' => 'คุณชอบวางแผนล่วงหน้า จองที่พัก จัดตารางไว้เลย', 
             'option_b' => 'คุณชอบไปเรื่อย ๆ คิดเอาหน้างานว่าทำอะไรดี'],
             
            ['question' => '32. คุณรู้สึกดีกว่าเมื่อ:', 
             'option_a' => 'ทุกอย่างเป็นระเบียบ จัดการเรียบร้อยแล้ว', 
             'option_b' => 'คุณมีทางเลือกและความยืดหยุ่นอยู่ตลอดเวลา'],
             
            ['question' => '33. เวลาทำงาน/เรียน:', 
             'option_a' => 'คุณมักทำงานให้เสร็จก่อนกำหนด เพราะไม่ชอบรีบตอนท้าย', 
             'option_b' => 'คุณมักทำงานใกล้เดดไลน์ เพราะรู้สึกมีแรงตอนนั้น'],
             
            ['question' => '34. ในชีวิตประจำวัน:', 
             'option_a' => 'คุณใช้ To-do list หรือแพลนเนอร์บ่อย ๆ', 
             'option_b' => 'คุณไม่ชอบถูกบังคับให้ทำตามแผนตลอดเวลา'],
             
            ['question' => '35. เวลาทำโปรเจกต์ร่วมกับคนอื่น:', 
             'option_a' => 'คุณอยากให้ทุกคนมีหน้าที่ชัดเจนและทำตามแผน', 
             'option_b' => 'คุณโอเคกับการปรับเปลี่ยนระหว่างทางตามสถานการณ์'],
             
            ['question' => '36. เวลาต้องตัดสินใจ:', 
             'option_a' => 'คุณชอบตัดสินใจให้เรียบร้อยและไปต่อเลย', 
             'option_b' => 'คุณอยากเปิดทางเลือกไว้นาน ๆ เผื่อเปลี่ยนใจ'],
             
            ['question' => '37. ถ้าคุณมีโปรเจกต์ที่ต้องทำในอีก 2 สัปดาห์:', 
             'option_a' => 'คุณเริ่มวางแผนทันที แบ่งเวลาชัดเจน', 
             'option_b' => 'คุณรอให้ใกล้ ๆ แล้วค่อยลงมือ ทำตอนแรงบันดาลใจมา'],
             
            ['question' => '38. คุณรู้สึกยังไงกับ "ความประหลาดใจ" ที่ไม่ได้วางแผนไว้?', 
             'option_a' => 'ไม่ค่อยชอบ รู้สึกไม่พร้อมหรือวุ่นวาย', 
             'option_b' => 'ตื่นเต้น รู้สึกว่าน่าสนุกและท้าทาย'],
             
            ['question' => '39. ถ้าเพื่อนเปลี่ยนแผนกระทันหัน:', 
             'option_a' => 'คุณอาจรู้สึกรำคาญนิด ๆ เพราะคุณวางแผนไว้แล้ว', 
             'option_b' => 'คุณรู้สึกโอเค ปรับตัวได้ง่าย ๆ'],
             
            ['question' => '40. ในการทำงาน:', 
             'option_a' => 'คุณชอบทำตามขั้นตอนจากต้นจนจบ', 
             'option_b' => 'คุณชอบทำหลายอย่างพร้อมกัน และเปลี่ยนลำดับได้ตามใจ'],
        ];

        return view('test.test', compact('e_i_questions', 's_n_questions', 't_f_questions', 'j_p_questions','tests'));

    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $answers = $request->all();

       

        // คำนวณผลลัพธ์จากคำตอบ
        $scores = [
            'E' => 0, 'I' => 0,
            'S' => 0, 'N' => 0,
            'T' => 0, 'F' => 0,
            'J' => 0, 'P' => 0,
        ];

        foreach ($answers as $question => $answer) {
            if ($question === '_token') {
                continue; // ข้าม token ไป
            }
        
            if (!isset($scores[$answer])) {
                continue; // ข้ามถ้าเป็นตัวอักษรที่ไม่รู้จัก เช่นผิดพลาดจาก frontend
            }
        
            $scores[$answer]++;
        }

        // แสดงผลลัพธ์
        $personality_type = $this->determinePersonality($scores);

        $test = new Test();
        $test->user_id = auth()->id(); // หรือใช้ Auth::id()
        $test->personality_type = $personality_type;
        $test->save();

        return redirect()->back()->with('success', "ผลลัพธ์ของคุณคือ: " . $personality_type);
        
    }

    private function determinePersonality($scores)
    {
        $personality = '';
        
        $personality .= ($scores['E'] >= $scores['I']) ? 'E' : 'I';
        $personality .= ($scores['S'] >= $scores['N']) ? 'S' : 'N';
        $personality .= ($scores['T'] >= $scores['F']) ? 'T' : 'F';
        $personality .= ($scores['J'] >= $scores['P']) ? 'J' : 'P';
        
        return $personality;
    }

    /**
     * Display the specified resource.
     */
    public function show(string $id)
    {
        $test = Test::findOrFail($id);

        $details = [
            'INTJ' => 'นักวางกลยุทธ์: มีวิสัยทัศน์ ชอบวางแผนระยะยาว และทำงานคนเดียวได้ดี',
            'INTP' => 'นักคิด: ชอบวิเคราะห์ข้อมูล มีตรรกะสูง และชอบสำรวจแนวคิดใหม่',
            'ENTJ' => 'ผู้นำ: มีความเป็นผู้นำสูง มีเป้าหมายชัดเจน และขับเคลื่อนองค์กรได้ดี',
            'ENTP' => 'นักประดิษฐ์: ชอบความคิดสร้างสรรค์ กล้าลองสิ่งใหม่ และมีไหวพริบดี',
            'INFJ' => 'นักอุดมคติ: เข้าใจผู้อื่นลึกซึ้ง มีเป้าหมายชัดเจน และเป็นแรงบันดาลใจให้คนอื่น',
            'INFP' => 'นักฝัน: มีอารมณ์ละเอียดอ่อน ยึดถือคุณธรรม และรักความสงบ',
            'ENFJ' => 'ผู้นำด้วยหัวใจ: เป็นมิตร มีอิทธิพลทางสังคม และเป็นผู้สนับสนุนคนรอบตัว',
            'ENFP' => 'นักสร้างแรงบันดาลใจ: สนุกสนาน ช่างจินตนาการ และมีพลังบวก',
            'ISTJ' => 'ผู้พิทักษ์: มีระเบียบ วางแผนเก่ง และยึดถือความรับผิดชอบ',
            'ISFJ' => 'ผู้ดูแล: อ่อนโยน ใส่ใจผู้อื่น และยึดมั่นในหน้าที่',
            'ESTJ' => 'ผู้บริหาร: เน้นประสิทธิภาพ ยึดตามระบบ และรักความถูกต้อง',
            'ESFJ' => 'นักสื่อสาร: เอาใจใส่ มนุษยสัมพันธ์ดี และชอบช่วยเหลือ',
            'ISTP' => 'นักแก้ปัญหา: เงียบ ช่างสังเกต และมีทักษะเชิงเทคนิค',
            'ISFP' => 'ศิลปิน: มีศิลปะ อ่อนโยน และใช้ชีวิตตามอารมณ์',
            'ESTP' => 'นักผจญภัย: ชอบความตื่นเต้น ลงมือทำเร็ว และมีพลังงานสูง',
            'ESFP' => 'นักแสดง: ร่าเริง รักการเข้าสังคม และชอบความสนุก',
        ];

        return view('test.show', [
            'test' => $test,
            'details' => $details,
            'selected_description' => $details[$test->personality_type] ?? 'ไม่พบคำอธิบายสำหรับบุคลิกภาพนี้',
        ]);
    }

    public function showResults()
{
    $tests = Test::where('user_id', auth()->id())->latest()->get(); // ดึงเฉพาะของผู้ใช้ปัจจุบัน

    return view('test.test', compact('tests'));
}

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(string $id)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, string $id)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id)
    {
        //
    }
}
